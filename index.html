<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UPI QR Extractor Pro</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
:root {
  --primary: #6C63FF;
  --secondary: #4CAF50;
  --danger: #ff5252;
  --info: #0ea5e9;
  /* Default Dark Theme */
  --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
  --card: rgba(255,255,255,0.05);
  --glass: rgba(255,255,255,0.08);
  --text: #ffffff;
  --input-bg: rgba(255,255,255,0.1);
}

/* Light Theme overrides */
body.light-mode {
  --bg-gradient: linear-gradient(135deg, #f1f5f9, #e2e8f0);
  --card: #ffffff;
  --glass: rgba(0,0,0,0.1);
  --text: #1e293b;
  --input-bg: #f1f5f9;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-gradient);
  color: var(--text);
  display: flex;
  justify-content: center;
  padding: 20px;
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

.container {
  width: 100%;
  max-width: 900px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.toggle-btn {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--glass);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}

h1 { text-align: center; margin-bottom: 10px; font-weight: 600; }

.tabs {
  display: flex;
  justify-content: center;
  margin: 20px 0;
  gap: 10px;
  flex-wrap: wrap;
}

.tab-btn {
  padding: 10px 20px;
  border-radius: 30px;
  border: none;
  cursor: pointer;
  background: var(--glass);
  color: var(--text);
  transition: 0.3s;
}

.tab-btn.active { background: var(--primary); color: white; }

.card {
  background: var(--card);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  text-align: center;
}

input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid var(--glass);
  background: var(--input-bg);
  color: var(--text);
  transition: 0.3s;
}

.btn-group {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 10px;
}

button.action-btn {
  padding: 12px 18px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 500;
  transition: 0.3s;
  flex: 1;
  min-width: 120px;
}

.btn-primary { background: var(--primary); color: white; }
.btn-success { background: var(--secondary); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-info { background: var(--info); color: white; }

button.action-btn:hover, .toggle-btn:hover { opacity: 0.8; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

#reader { 
  width: 100%; 
  border-radius: 12px; 
  overflow: hidden;
  margin-bottom: 15px;
}

#generatedQR { margin-top: 15px; }
#generatedQR canvas { border-radius: 12px; }

.message {
  padding: 10px;
  border-radius: 8px;
  margin-top: 15px;
  display: none;
  text-align: center;
}

.success { background: rgba(76,175,80,0.2); border: 1px solid var(--secondary); }
.error { background: rgba(255,82,82,0.2); border: 1px solid var(--danger); }

@media (max-width: 600px) {
  .tabs { flex-direction: column; }
  .btn-group { flex-direction: column; }
}
</style>
</head>
<body>

<div class="container">
  <div class="top-bar">
    <button class="toggle-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è Light Mode</button>
    <button class="toggle-btn" onclick="toggleLang()" id="langBtn">‡§Ö / A</button>
  </div>

<h1 id="mainTitle">UPI QR Extractor Pro</h1>

<div class="tabs">
  <button class="tab-btn active" id="tabScan" onclick="switchTab('scan')">Scan</button>
  <button class="tab-btn" id="tabUpload" onclick="switchTab('upload')">Upload</button>
  <button class="tab-btn" id="tabGenerate" onclick="switchTab('generate')">Generate</button>
</div>

<div id="scan" class="card tab-content">
  <div id="reader"></div>
  <div class="btn-group">
    <button class="action-btn btn-primary" id="btnStartCam" onclick="startScanner()">Start Camera</button>
    <button class="action-btn btn-danger" id="btnStopCam" onclick="stopScanner()" style="display:none;">Stop Camera</button>
  </div>
</div>

<div id="upload" class="card tab-content" style="display:none;">
  <input type="file" id="qrFile" accept="image/*">
</div>

<div id="generate" class="card tab-content" style="display:none;">
  <input type="text" id="newUpiId" placeholder="UPI ID (e.g., name@bank)">
  <input type="text" id="newName" placeholder="Name">
  <input type="number" id="newAmount" placeholder="Amount">
  <button class="action-btn btn-primary" id="btnGenQR" onclick="generateQR()">Generate QR</button>
  
  <div id="generatedQR"></div>
  <div class="btn-group" id="genActions" style="display:none;">
    <button class="action-btn btn-success" id="btnDownload" onclick="downloadQR()">Download QR</button>
    <button class="action-btn btn-info" id="btnShareGen" onclick="shareUPI('generate')">Share Link</button>
  </div>
</div>

<div class="card">
  <h3 id="extractTitle">Extracted Details</h3>
  <input type="text" id="upiId" placeholder="UPI ID" readonly>
  <input type="text" id="merchantName" placeholder="Merchant Name" readonly>
  <input type="text" id="amount" placeholder="Amount" readonly>
  
  <div class="btn-group">
    <button class="action-btn btn-primary" id="btnCopy" onclick="copyUPI()">Copy UPI</button>
    <button class="action-btn btn-info" id="btnShareExt" onclick="shareUPI('extract')">Share</button>
    <button class="action-btn btn-success" id="btnPay" onclick="openUPI()">Pay Now</button>
  </div>
  <div id="msg" class="message"></div>
</div>

</div>

<script>
// --- Translations ---
const dict = {
  en: {
    themeDark: "üåô Dark Mode", themeLight: "‚òÄÔ∏è Light Mode",
    mainTitle: "UPI QR Extractor Pro",
    tabScan: "Scan", tabUpload: "Upload", tabGenerate: "Generate",
    newUpiId: "UPI ID", newName: "Name", newAmount: "Amount", btnGenQR: "Generate QR",
    extractTitle: "Extracted Details",
    upiId: "UPI ID", merchantName: "Merchant Name", amount: "Amount",
    btnCopy: "Copy", btnPay: "Pay Now", btnShareExt: "Share", btnShareGen: "Share Link", btnDownload: "Download QR",
    btnStartCam: "Start Camera", btnStopCam: "Stop Camera",
    msgInvalid: "Invalid UPI QR", msgExtracted: "UPI QR Extracted Successfully",
    msgNoRead: "Cannot read QR", msgCopied: "UPI Copied!",
    msgNoUpi: "No UPI ID Found", msgEnterUpi: "Enter UPI ID", msgGenerated: "QR Generated!",
    msgInvalidFormat: "Invalid UPI ID Format (missing @)", msgShareSuccess: "Shared successfully!", msgShareFail: "Sharing failed or unsupported."
  },
  hi: {
    themeDark: "üåô ‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°", themeLight: "‚òÄÔ∏è ‡§≤‡§æ‡§á‡§ü ‡§Æ‡•ã‡§°",
    mainTitle: "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§∏‡•ç‡§ï‡•à‡§®‡§∞ ‡§™‡•ç‡§∞‡•ã",
    tabScan: "‡§∏‡•ç‡§ï‡•à‡§®", tabUpload: "‡§Ö‡§™‡§≤‡•ã‡§°", tabGenerate: "‡§¨‡§®‡§æ‡§è‡§Ç",
    newUpiId: "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä", newName: "‡§®‡§æ‡§Æ", newAmount: "‡§∞‡§æ‡§∂‡§ø", btnGenQR: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç",
    extractTitle: "‡§®‡§ø‡§ï‡§æ‡§≤‡•á ‡§ó‡§è ‡§µ‡§ø‡§µ‡§∞‡§£",
    upiId: "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä", merchantName: "‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ", amount: "‡§∞‡§æ‡§∂‡§ø",
    btnCopy: "‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç", btnPay: "‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç", btnShareExt: "‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç", btnShareGen: "‡§≤‡§ø‡§Ç‡§ï ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç", btnDownload: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
    btnStartCam: "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç", btnStopCam: "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
    msgInvalid: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞", msgExtracted: "‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§®‡§ø‡§ï‡§æ‡§≤‡§æ ‡§ó‡§Ø‡§æ",
    msgNoRead: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§™‡§¢‡§º‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ ‡§∏‡§ï‡§æ", msgCopied: "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!",
    msgNoUpi: "‡§ï‡•ã‡§à ‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä", msgEnterUpi: "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", msgGenerated: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§¨‡§® ‡§ó‡§Ø‡§æ!",
    msgInvalidFormat: "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™ (@ ‡§ó‡§æ‡§Ø‡§¨ ‡§π‡•à)", msgShareSuccess: "‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", msgShareFail: "‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ‡•§"
  }
};

let currentLang = 'en';

function toggleLang() {
  currentLang = currentLang === 'en' ? 'hi' : 'en';
  
  // Update UI Elements
  document.getElementById("mainTitle").innerText = dict[currentLang].mainTitle;
  document.getElementById("tabScan").innerText = dict[currentLang].tabScan;
  document.getElementById("tabUpload").innerText = dict[currentLang].tabUpload;
  document.getElementById("tabGenerate").innerText = dict[currentLang].tabGenerate;
  document.getElementById("btnGenQR").innerText = dict[currentLang].btnGenQR;
  document.getElementById("extractTitle").innerText = dict[currentLang].extractTitle;
  document.getElementById("btnCopy").innerText = dict[currentLang].btnCopy;
  document.getElementById("btnPay").innerText = dict[currentLang].btnPay;
  document.getElementById("btnShareExt").innerText = dict[currentLang].btnShareExt;
  document.getElementById("btnShareGen").innerText = dict[currentLang].btnShareGen;
  document.getElementById("btnDownload").innerText = dict[currentLang].btnDownload;
  document.getElementById("btnStartCam").innerText = dict[currentLang].btnStartCam;
  document.getElementById("btnStopCam").innerText = dict[currentLang].btnStopCam;
  
  // Update Placeholders
  document.getElementById("newUpiId").placeholder = dict[currentLang].newUpiId;
  document.getElementById("newName").placeholder = dict[currentLang].newName;
  document.getElementById("newAmount").placeholder = dict[currentLang].newAmount;
  document.getElementById("upiId").placeholder = dict[currentLang].upiId;
  document.getElementById("merchantName").placeholder = dict[currentLang].merchantName;
  document.getElementById("amount").placeholder = dict[currentLang].amount;
  
  updateThemeText();
}

// --- Theme Toggle ---
function toggleTheme() {
  document.body.classList.toggle("light-mode");
  updateThemeText();
}
function updateThemeText() {
  const isLight = document.body.classList.contains("light-mode");
  document.getElementById("themeBtn").innerText = isLight ? dict[currentLang].themeDark : dict[currentLang].themeLight;
}

// --- UI / Messages ---
function showMessage(msgKey, type) {
  const msg = document.getElementById("msg");
  msg.innerText = dict[currentLang][msgKey];
  msg.className = "message " + type;
  msg.style.display = "block";
  setTimeout(()=>msg.style.display="none",3000);
}

// --- Tab Switching & Camera Optimization ---
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.style.display='none');
  document.getElementById(tab).style.display='block';
  document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
  event.target.classList.add('active');

  // Optimise Camera: Stop it if we leave the scan tab
  if (tab !== 'scan') {
    stopScanner();
  } else {
    // Optional: Auto-start camera when returning to scan tab
    // startScanner(); 
  }
}

// --- Camera Logic (Custom UI) ---
let html5QrCode;
let isScanning = false;

function initScanner() {
  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("reader");
  }
}

function startScanner() {
  initScanner();
  html5QrCode.start(
    { facingMode: "environment" }, 
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      extractUPI(decodedText);
      stopScanner(); // Auto-stop after successful scan
    },
    (errorMessage) => { /* Silently handle background scan errors */ }
  ).then(() => {
    isScanning = true;
    document.getElementById("btnStartCam").style.display = "none";
    document.getElementById("btnStopCam").style.display = "inline-block";
  }).catch(err => {
    console.error("Camera start failed", err);
    showMessage("msgNoRead", "error");
  });
}

function stopScanner() {
  if (html5QrCode && isScanning) {
    html5QrCode.stop().then(() => {
      isScanning = false;
      document.getElementById("btnStartCam").style.display = "inline-block";
      document.getElementById("btnStopCam").style.display = "none";
    }).catch(err => console.error("Failed to stop scanner", err));
  }
}

// --- Data Extraction & Formatting ---
function extractUPI(text) {
  if (!text.startsWith("upi://pay")) {
    showMessage("msgInvalid", "error");
    return;
  }
  const url = new URL(text);
  document.getElementById("upiId").value = url.searchParams.get("pa") || "";
  document.getElementById("merchantName").value = url.searchParams.get("pn") || "";
  
  // Format Amount with ‚Çπ
  let rawAmount = url.searchParams.get("am") || "";
  document.getElementById("amount").dataset.raw = rawAmount; // Store raw value invisibly
  document.getElementById("amount").value = rawAmount ? `‚Çπ ${rawAmount}` : "";

  showMessage("msgExtracted", "success");
}

// --- Upload Logic ---
document.getElementById("qrFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if(!file) return;
  initScanner();
  html5QrCode.scanFile(file, true)
    .then(decodedText => extractUPI(decodedText))
    .catch(() => showMessage("msgNoRead", "error"));
});

// --- Action Buttons ---
function copyUPI() {
  const input = document.getElementById("upiId");
  if(!input.value) return;
  input.select();
  document.execCommand("copy");
  showMessage("msgCopied", "success");
}

function openUPI() {
  const pa = document.getElementById("upiId").value;
  const pn = document.getElementById("merchantName").value;
  const am = document.getElementById("amount").dataset.raw; // Retrieve unformatted amount

  if (!pa) { showMessage("msgNoUpi", "error"); return; }

  let link = `upi://pay?pa=${pa}&pn=${pn}&cu=INR`;
  if (am) link += `&am=${am}`;
  window.location.href = link;
}

// --- Web Share API ---
async function shareUPI(source) {
  let textToShare = "";
  let title = "UPI Payment Link";
  
  if (source === 'extract') {
    const pa = document.getElementById("upiId").value;
    if (!pa) return;
    textToShare = `Pay via UPI: upi://pay?pa=${pa}&cu=INR`;
  } else if (source === 'generate') {
    const pa = document.getElementById("newUpiId").value;
    const pn = document.getElementById("newName").value;
    const am = document.getElementById("newAmount").value;
    let link = `upi://pay?pa=${pa}&pn=${pn}&cu=INR`;
    if (am) link += `&am=${am}`;
    textToShare = `Here is my UPI payment link: ${link}`;
  }

  if (navigator.share) {
    try {
      await navigator.share({
        title: title,
        text: textToShare
      });
      showMessage("msgShareSuccess", "success");
    } catch (error) {
      console.error('Error sharing', error);
    }
  } else {
    showMessage("msgShareFail", "error");
  }
}

// --- Generate & Download ---
function generateQR() {
  const pa = document.getElementById("newUpiId").value.trim();
  const pn = document.getElementById("newName").value.trim();
  const am = document.getElementById("newAmount").value.trim();
  
  if (!pa) { showMessage("msgEnterUpi", "error"); return; }
  
  // Basic Form Validation for UPI ID
  if (!pa.includes('@')) {
    showMessage("msgInvalidFormat", "error");
    return;
  }

  let upiString = `upi://pay?pa=${pa}&pn=${pn}&cu=INR`;
  if (am) upiString += `&am=${am}`;

  document.getElementById("generatedQR").innerHTML = "";

  QRCode.toCanvas(upiString, { width: 220, margin: 2 }, function (err, canvas) {
    if (err) console.error(err);
    document.getElementById("generatedQR").appendChild(canvas);
    document.getElementById("genActions").style.display = "flex"; // Show Download/Share buttons
  });
  
  showMessage("msgGenerated", "success");
}

function downloadQR() {
  const canvas = document.querySelector("#generatedQR canvas");
  if (!canvas) return;
  
  const image = canvas.toDataURL("image/png");
  const link = document.createElement('a');
  link.href = image;
  link.download = 'UPI-QR-Code.png';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
</html>
