<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>UPI QR Extractor Pro</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --primary: #6C63FF;
  --primary-hover: #5A52D5;
  --secondary: #10B981;
  --secondary-hover: #059669;
  --danger: #EF4444;
  --info: #3B82F6;
  --info-hover: #2563EB;
  --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
  --card: rgba(255, 255, 255, 0.03);
  --card-border: rgba(255, 255, 255, 0.1);
  --glass: rgba(255, 255, 255, 0.05);
  --text: #F8FAFC;
  --text-muted: #94A3B8;
  --input-bg: rgba(0, 0, 0, 0.2);
}

body.light-mode {
  --bg-gradient: linear-gradient(135deg, #F8FAFC, #E2E8F0);
  --card: #FFFFFF;
  --card-border: rgba(0, 0, 0, 0.05);
  --glass: rgba(0, 0, 0, 0.05);
  --text: #0F172A;
  --text-muted: #64748B;
  --input-bg: #F1F5F9;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body { margin: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-gradient); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 16px; min-height: 100vh; transition: background 0.4s ease, color 0.4s ease; opacity: 0; animation: pageLoad 0.6s ease forwards; }

@keyframes pageLoad { to { opacity: 1; } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.container { width: 100%; max-width: 600px; padding-bottom: 20px; flex: 1; }
.animate-fade { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

.top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.toggle-btn { background: var(--glass); color: var(--text); border: 1px solid var(--card-border); padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.3s ease; font-weight: 500; display: flex; align-items: center; gap: 6px; }
.toggle-btn:hover { background: var(--card); }

.hero-text { text-align: center; margin-bottom: 24px; }
h1 { margin: 0 0 8px 0; font-weight: 700; font-size: 1.5rem; letter-spacing: -0.5px; }
.subtitle { color: var(--text-muted); font-size: 0.9rem; margin: 0; }

/* 2-Category Tab Layout */
.tabs { display: flex; justify-content: center; margin-bottom: 24px; background: var(--input-bg); padding: 6px; border-radius: 30px; gap: 6px; }
.tab-btn { flex: 1; padding: 12px 16px; border-radius: 24px; border: none; cursor: pointer; background: transparent; color: var(--text-muted); transition: all 0.3s ease; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
.tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3); }

.card { background: var(--card); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--card-border); border-radius: 20px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
.card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08); }

input { width: 100%; padding: 14px 16px; margin: 8px 0 16px; border-radius: 12px; border: 1px solid var(--card-border); background: var(--input-bg); color: var(--text); font-size: 1rem; transition: all 0.3s ease; outline: none; }
input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.15); }
input.valid { border-color: var(--secondary); }
input.invalid { border-color: var(--danger); }

.detail-group { margin-bottom: 16px; text-align: left; }
.detail-label { display: block; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
.detail-value { background: var(--input-bg); padding: 14px 16px; border-radius: 12px; font-size: 1.05rem; font-weight: 500; border: 1px solid var(--card-border); word-break: break-all; }

.btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
button.action-btn { padding: 14px 20px; border-radius: 14px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s ease; flex: 1; min-width: 130px; display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 48px; position: relative; overflow: hidden; }
button.action-btn:active { transform: scale(0.97); }
button.action-btn::after { content: ""; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease; opacity: 1; }
button.action-btn:active::after { width: 300px; height: 300px; opacity: 0; }

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-success { background: var(--secondary); color: white; }
.btn-success:hover { background: var(--secondary-hover); }
.btn-danger { background: var(--danger); color: white; }
.btn-info { background: var(--info); color: white; }
.btn-info:hover { background: var(--info-hover); }
.btn-outline { background: var(--glass); color: var(--text); border: 1px solid var(--card-border); }
.btn-outline:hover { background: var(--input-bg); }

/* --- SCANNER --- */
.scanner-container { position: relative; border-radius: 16px; overflow: hidden; background: #000; margin-bottom: 16px; width: 100%; min-height: 250px; }
#reader { width: 100%; border: none; }
#reader video { object-fit: cover; border-radius: 16px; }
.scan-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 10; }
.scan-box { width: 70%; max-width: 250px; aspect-ratio: 1/1; border-radius: 16px; position: relative; border: 2px solid var(--secondary); box-shadow: 0 0 12px rgba(16, 185, 129, 0.6), 0 0 0 4000px rgba(0,0,0,0.5); }
.scan-laser { width: 100%; height: 2px; background: var(--secondary); box-shadow: 0 0 10px var(--secondary); position: absolute; top: 0; animation: scan 2s infinite linear; }
@keyframes scan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
.scan-hint { color: white; margin-top: 20px; font-size: 0.9rem; font-weight: 500; text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 11; }
.torch-btn { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; color: white; backdrop-filter: blur(8px); transition: all 0.3s ease; pointer-events: auto; }
.torch-btn.active { background: #EAB308; color: #000; border-color: #EAB308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); }
.torch-btn:active { transform: scale(0.9); }

/* --- MERCHANT STANDEE CARD --- */
.qr-standee-wrapper { background: #FFFFFF; border-radius: 16px; padding: 24px; width: 100%; max-width: 320px; margin: 20px auto; color: #0F172A; box-shadow: 0 12px 32px rgba(0,0,0,0.15); font-family: 'Inter', sans-serif; border: 1px solid #E2E8F0; }
.qr-standee-header { text-align: center; margin-bottom: 16px; }
.qr-standee-header h3 { margin: 0; font-size: 1.25rem; color: #0F172A; font-weight: 700; word-break: break-word; }
.qr-standee-upi { margin: 4px 0 0 0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.85rem; color: #6C63FF; font-weight: 600; word-break: break-all; }
.qr-standee-header p.scan-prompt { margin: 10px 0 0 0; color: #64748B; font-size: 0.9rem; font-weight: 500; }
.qr-standee-amount { color: #10B981; font-size: 1.1rem; font-weight: 700; margin-top: 4px; }
#cardQrCode { display: flex; justify-content: center; background: #FFFFFF; border-radius: 12px; padding: 10px; border: 2px solid #F1F5F9; }
#cardQrCode canvas { max-width: 100%; height: auto !important; }
.qr-standee-footer { text-align: center; margin-top: 20px; border-top: 2px dashed #E2E8F0; padding-top: 16px; }
.upi-apps { display: block; font-size: 0.75rem; color: #64748B; font-weight: 600; margin-bottom: 6px; letter-spacing: 0.5px; }
.powered-by { font-size: 1rem; color: #0F172A; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; }
.powered-by span { background: #0F172A; color: #FFFFFF; padding: 2px 8px; border-radius: 6px; font-weight: 800; font-style: italic; font-size: 0.9rem; }

.trust-badge { display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-muted); font-size: 0.85rem; margin-top: 30px; }
.trust-badge svg { width: 16px; height: 16px; fill: currentColor; }
.message { padding: 12px; border-radius: 10px; margin-top: 16px; display: none; text-align: center; font-weight: 500; z-index: 100; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
.success { background: rgba(16, 185, 129, 0.9); color: white; border: 1px solid rgba(16, 185, 129, 1); }
.error { background: rgba(239, 68, 68, 0.9); color: white; border: 1px solid rgba(239, 68, 68, 1); }
.hidden { display: none !important; }
.icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

@media (max-width: 480px) { .btn-group { flex-direction: column; } }
</style>
</head>
<body>

<div class="container">
  <div class="top-bar">
    <button class="toggle-btn" onclick="toggleTheme()" id="themeBtn">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg> Light
    </button>
    <button class="toggle-btn" onclick="toggleLang()" id="langBtn">EN | हिंदी</button>
  </div>

  <div class="hero-text animate-fade">
    <h1 id="mainTitle">UPI QR Extractor</h1>
    <p class="subtitle" id="subTitle">Scan, extract, or create UPI codes instantly.</p>
  </div>

  <div class="tabs animate-fade">
    <button class="tab-btn active" id="tabScan" onclick="switchTab('scanTab', this)">
      <svg class="icon" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      <span id="txtTabScan">Scan & Pay</span>
    </button>
    <button class="tab-btn" id="tabCreate" onclick="switchTab('createTab', this)">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
      <span id="txtTabCreate">Create & Receive</span>
    </button>
  </div>

  <div id="scanTab" class="card tab-content animate-fade">
    <div id="scannerWrapper" class="scanner-container hidden">
      <div id="reader"></div>
      <div class="scan-overlay">
        <div class="scan-box"><div class="scan-laser"></div></div>
        <div class="scan-hint" id="scanHint">Align QR inside the box</div>
        <button id="btnTorch" class="torch-btn hidden" onclick="toggleTorch()" aria-label="Toggle Flashlight">
          <svg class="icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
        </button>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="action-btn btn-primary" id="btnStartCam" onclick="startScanner()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
        <span id="txtStartCam">Live Camera</span>
      </button>
      <button class="action-btn btn-danger hidden" id="btnStopCam" onclick="stopScanner()">
        <svg class="icon" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        <span id="txtStopCam">Stop Camera</span>
      </button>
      
      <button class="action-btn btn-outline" onclick="document.getElementById('qrFile').click()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span id="txtUploadImg">Upload Gallery</span>
      </button>
      <input type="file" id="qrFile" class="hidden" accept="image/*">
    </div>
  </div>

  <div id="createTab" class="card tab-content hidden animate-fade">
    <div class="detail-group">
      <label class="detail-label">UPI ID *</label>
      <input type="text" id="newUpiId" placeholder="e.g., name@bank" onkeyup="validateLive()">
    </div>
    <div class="detail-group">
      <label class="detail-label">Payee Name (Optional)</label>
      <input type="text" id="newName" placeholder="e.g., Rahul Traders">
    </div>
    <div class="detail-group">
      <label class="detail-label">Amount (Optional)</label>
      <input type="number" id="newAmount" placeholder="₹ 0.00">
    </div>

    <div class="btn-group">
      <button class="action-btn btn-primary" onclick="generateQRCard()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg> 
        <span id="txtGenQR">QR Card</span>
      </button>
      <button class="action-btn btn-info" onclick="generateLink()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
        <span id="txtGenLinkBtn">Copy Link</span>
      </button>
      <button class="action-btn btn-outline" style="flex: 0.5; min-width: 80px;" onclick="resetCreateForm()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> 
      </button>
    </div>
    
    <div id="qrStandee" class="qr-standee-wrapper hidden">
      <div class="qr-standee-header">
        <h3 id="standeeName">UPI Payment</h3>
        <p id="standeeUpiId" class="qr-standee-upi"></p>
        <p id="txtScanToPay" class="scan-prompt">Scan and Pay</p>
        <div id="standeeAmount" class="qr-standee-amount"></div>
      </div>
      <div id="cardQrCode"></div>
      <div class="qr-standee-footer">
        <span class="upi-apps">GPay • PhonePe • Paytm • BHIM</span>
        <div class="powered-by">Powered by <span>UPI</span></div>
      </div>
    </div>
    
    <div class="btn-group hidden" id="cardActions">
      <button class="action-btn btn-success" id="btnDownload" onclick="downloadStandee()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> <span id="txtDownload">Save Image</span>
      </button>
      <button class="action-btn btn-info" onclick="shareStandee()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg> <span id="txtShareGen">Share Image</span>
      </button>
    </div>
  </div>

  <div class="card hidden animate-fade" id="extractedCard">
    <h3 id="extractTitle" style="margin-top: 0; color: var(--secondary); text-align: center;">Scanned Successfully</h3>
    <div class="detail-group"><span class="detail-label" id="lblUpi">UPI ID</span><div class="detail-value" id="valUpiId">-</div></div>
    <div class="detail-group"><span class="detail-label" id="lblMerchant">Merchant / Payee Name</span><div class="detail-value" id="valMerchant">-</div></div>
    <div class="detail-group"><span class="detail-label" id="lblAmount">Amount</span><div class="detail-value" id="valAmount" style="color: var(--secondary); font-size: 1.2rem; font-weight: 700;">-</div></div>
    
    <div class="btn-group">
      <button class="action-btn btn-primary" onclick="copyUPI()"><svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> <span id="txtCopy">Copy ID</span></button>
      <button class="action-btn btn-success" onclick="openUPI()"><svg class="icon" viewBox="0 0 24 24"><path d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg> <span id="txtPay">Pay Now</span></button>
    </div>
  </div>

  <div id="msg" class="message"></div>

  <div class="trust-badge animate-fade">
    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4"/></svg>
    <span id="trustText">100% Secure. Runs locally in your browser.</span>
  </div>

</div>

<footer style="text-align:center; margin-top: auto; padding: 20px; font-size: 0.9rem; color: var(--text-muted); width: 100%;">
  © <span id="year"></span> Made with ❤️ by <strong>You</strong>
</footer>

<script>
document.getElementById("year").innerText = new Date().getFullYear();

// Configuration
const BASE_PAY_URL = "https://pagalpraani.github.io/upi/index.html";

// --- Initialization & LocalStorage ---
let currentLang = 'en';

window.addEventListener('DOMContentLoaded', () => {
  if(localStorage.getItem("theme") === "light") {
    document.body.classList.add("light-mode");
    updateThemeIcon(true);
  }
  if(localStorage.getItem("lang")) {
    currentLang = localStorage.getItem("lang");
    applyLanguage();
  }
});

// --- Translations & Theme ---
const translations = {
  en: {
    mainTitle: "UPI QR Extractor", subTitle: "Scan, extract, or create UPI codes instantly.",
    txtTabScan: "Scan & Pay", txtTabCreate: "Create & Receive",
    txtStartCam: "Live Camera", txtStopCam: "Stop Camera", scanHint: "Align QR inside the box", txtUploadImg: "Upload Gallery",
    extractTitle: "Scanned Successfully", lblUpi: "UPI ID", lblMerchant: "Merchant / Payee Name", lblAmount: "Amount",
    txtCopy: "Copy ID", txtPay: "Pay Now", 
    txtGenQR: "QR Card", txtGenLinkBtn: "Copy Link",
    txtDownload: "Save Image", txtShareGen: "Share Image",
    txtScanToPay: "Scan and Pay", trustText: "100% Secure. Runs locally in your browser."
  },
  hi: {
    mainTitle: "यूपीआई क्यूआर स्कैनर", subTitle: "तुरंत यूपीआई कोड स्कैन करें, निकालें या बनाएं।",
    txtTabScan: "स्कैन और भुगतान", txtTabCreate: "बनाएं और प्राप्त करें",
    txtStartCam: "लाइव कैमरा", txtStopCam: "कैमरा बंद करें", scanHint: "क्यूआर को बॉक्स के अंदर रखें", txtUploadImg: "गैलरी से अपलोड",
    extractTitle: "सफलतापूर्वक स्कैन किया गया", lblUpi: "यूपीआई आईडी", lblMerchant: "व्यापारी का नाम", lblAmount: "रकम",
    txtCopy: "कॉपी करें", txtPay: "भुगतान करें", 
    txtGenQR: "क्यूआर कार्ड", txtGenLinkBtn: "लिंक कॉपी करें",
    txtDownload: "छवि सहेजें", txtShareGen: "छवि साझा करें",
    txtScanToPay: "भुगतान करने के लिए स्कैन करें", trustText: "100% सुरक्षित। आपके ब्राउज़र में चलता है।"
  }
};

function toggleLang() {
  currentLang = currentLang === 'en' ? 'hi' : 'en';
  localStorage.setItem("lang", currentLang);
  applyLanguage();
}

function applyLanguage() {
  document.getElementById('langBtn').innerText = currentLang === 'en' ? 'EN | हिंदी' : 'हिंदी | EN';
  const t = translations[currentLang];
  Object.keys(t).forEach(id => {
    const el = document.getElementById(id);
    if(el) {
      if(el.childNodes.length > 1 && el.tagName === "BUTTON") {
         el.lastElementChild.innerText = t[id];
      } else if (el.tagName === "H3" && el.childNodes.length > 1) {
         el.lastChild.nodeValue = " " + t[id];
      } else {
         el.innerText = t[id];
      }
    }
  });
}

function updateThemeIcon(isLight) {
  const icon = isLight ? '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>' : '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
  document.getElementById("themeBtn").innerHTML = `<svg class="icon" viewBox="0 0 24 24">${icon}</svg> ${isLight ? 'Dark' : 'Light'}`;
}

function toggleTheme() {
  document.body.classList.toggle("light-mode");
  const isLight = document.body.classList.contains("light-mode");
  localStorage.setItem("theme", isLight ? "light" : "dark");
  updateThemeIcon(isLight);
}

function showMessage(text, type) {
  const msg = document.getElementById("msg");
  msg.innerText = text;
  msg.className = "message " + type;
  msg.style.display = "block";
  msg.style.animation = "none";
  msg.offsetHeight; // force reflow
  msg.style.animation = "fadeInUp 0.3s ease";

  clearTimeout(msg.hideTimeout);
  msg.hideTimeout = setTimeout(() => {
    msg.style.animation = "fadeInUp 0.3s ease reverse forwards";
    setTimeout(() => { msg.style.display = "none"; }, 300);
  }, 3000);
}

function switchTab(tabId, btnElement) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById(tabId).classList.remove('hidden');
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  btnElement.classList.add('active');
  document.getElementById("extractedCard").classList.add("hidden");
  if (tabId === 'createTab') stopScanner();
}

const upiRegex = /^[\w.-]+@[\w.-]+$/;
function validateLive() {
  const input = document.getElementById("newUpiId");
  const val = input.value.trim();
  if(val.length === 0) { input.classList.remove("valid", "invalid"); } 
  else if(upiRegex.test(val)) { input.classList.add("valid"); input.classList.remove("invalid"); } 
  else { input.classList.add("invalid"); input.classList.remove("valid"); }
}

// --- TAB 1: SCAN & PAY LOGIC ---
let html5QrCode;
let isScanning = false;
let isTorchOn = false; 
let rawAmountVal = "";

function initScanner() { if (!html5QrCode) html5QrCode = new Html5Qrcode("reader"); }

function startScanner() {
  initScanner();
  document.getElementById("extractedCard").classList.add("hidden");
  document.getElementById("scannerWrapper").classList.remove("hidden");
  document.getElementById("btnStartCam").classList.add("hidden");
  document.getElementById("btnStopCam").classList.remove("hidden");
  
  let qrboxSize = window.innerWidth < 350 ? 180 : 250;

  html5QrCode.start(
    { facingMode: "environment" }, 
    { fps: 10, qrbox: { width: qrboxSize, height: qrboxSize } },
    (decodedText) => { extractUPI(decodedText); stopScanner(); if(navigator.vibrate) navigator.vibrate(200); },
    (errorMessage) => {}
  ).then(() => {
    isScanning = true;
    document.getElementById("btnTorch").classList.remove("hidden");
  }).catch(err => {
    document.getElementById("scannerWrapper").classList.add("hidden");
    document.getElementById("btnStartCam").classList.remove("hidden");
    document.getElementById("btnStopCam").classList.add("hidden");
    document.getElementById("btnTorch").classList.add("hidden");
    showMessage(currentLang === 'en' ? "Camera access denied." : "कैमरा अनुमति अस्वीकृत।", "error");
  });
}

async function stopScanner() {
  if (html5QrCode && isScanning) {
    try { 
      await html5QrCode.stop(); 
      isScanning = false; 
      isTorchOn = false;
      document.getElementById("btnTorch").classList.remove("active", "hidden");
      document.getElementById("btnTorch").classList.add("hidden");
      document.getElementById("scannerWrapper").classList.add("hidden"); 
      document.getElementById("btnStartCam").classList.remove("hidden"); 
      document.getElementById("btnStopCam").classList.add("hidden"); 
    } catch(err) {}
  }
}

function toggleTorch() {
  if (html5QrCode && isScanning) {
    isTorchOn = !isTorchOn;
    html5QrCode.applyVideoConstraints({ advanced: [{ torch: isTorchOn }] }).then(() => {
      const btn = document.getElementById("btnTorch");
      isTorchOn ? btn.classList.add("active") : btn.classList.remove("active");
    }).catch(err => {
      isTorchOn = false;
      showMessage(currentLang === 'en' ? "Flashlight not supported." : "फ्लैशलाइट समर्थित नहीं है।", "error");
    });
  }
}

function extractUPI(text) {
  if (!text.startsWith("upi://pay")) { showMessage(currentLang === 'en' ? "Invalid UPI QR" : "अमान्य यूपीआई क्यूआर", "error"); return; }
  const url = new URL(text);
  const upiId = url.searchParams.get("pa") || "N/A";
  const mName = url.searchParams.get("pn") || "N/A";
  rawAmountVal = url.searchParams.get("am") || "";

  document.getElementById("valUpiId").innerText = upiId;
  document.getElementById("valMerchant").innerText = mName;
  document.getElementById("valAmount").innerText = rawAmountVal ? `₹ ${rawAmountVal}` : "Not Specified";

  document.getElementById("extractedCard").classList.remove("hidden");
  document.getElementById("extractedCard").scrollIntoView({ behavior: 'smooth' });
}

document.getElementById("qrFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if(!file) return;
  document.getElementById("extractedCard").classList.add("hidden");
  initScanner();
  html5QrCode.scanFile(file, true).then(decodedText => extractUPI(decodedText)).catch(() => showMessage(currentLang === 'en' ? "Cannot read QR" : "क्यूआर नहीं पढ़ सकते", "error"));
  // Reset input so same file can be selected again if needed
  e.target.value = ''; 
});

function copyUPI() {
  const upiId = document.getElementById("valUpiId").innerText;
  if(upiId === "N/A") return;
  navigator.clipboard.writeText(upiId).then(() => { showMessage(currentLang === 'en' ? "UPI ID Copied!" : "UPI ID कॉपी किया गया!", "success"); });
}

function openUPI() {
  const pa = document.getElementById("valUpiId").innerText;
  const pn = document.getElementById("valMerchant").innerText;
  let link = `upi://pay?pa=${pa}&pn=${pn}&cu=INR`;
  if (rawAmountVal) link += `&am=${rawAmountVal}`;
  window.open(link, "_self"); 
}

// --- TAB 2: CREATE & RECEIVE LOGIC ---
function getFormValues() {
  const pa = document.getElementById("newUpiId").value.trim().toLowerCase();
  const pn = document.getElementById("newName").value.trim();
  const am = document.getElementById("newAmount").value.trim();
  if (!upiRegex.test(pa)) { 
    showMessage(currentLang === 'en' ? "Enter a valid UPI ID" : "मान्य यूपीआई आईडी दर्ज करें", "error"); 
    document.getElementById("newUpiId").classList.add("invalid"); return null; 
  }
  return { pa, pn, am };
}

function generateQRCard() {
  const data = getFormValues();
  if(!data) return;

  let upiString = `upi://pay?pa=${data.pa}&pn=${data.pn}&cu=INR`;
  if (data.am) upiString += `&am=${data.am}`;

  document.getElementById("cardQrCode").innerHTML = "";

  document.getElementById("standeeName").innerText = data.pn ? data.pn : (currentLang === 'en' ? "UPI Payment" : "यूपीआई भुगतान");
  document.getElementById("standeeUpiId").innerText = data.pa;
  document.getElementById("standeeAmount").innerText = data.am ? `₹ ${data.am}` : "";

  const qrCodeInstance = new QRCodeStyling({
    width: 240, height: 240, type: "canvas", data: upiString,
    qrOptions: { errorCorrectionLevel: 'M' }, 
    dotsOptions: { color: "#000000", type: "square" },
    backgroundOptions: { color: "#FFFFFF" }
  });

  qrCodeInstance.append(document.getElementById("cardQrCode"));
  
  document.getElementById("qrStandee").classList.remove("hidden");
  document.getElementById("cardActions").classList.remove("hidden");
  document.getElementById("qrStandee").scrollIntoView({ behavior: "smooth", block: "nearest" });
  showMessage(currentLang === 'en' ? "Card Generated!" : "कार्ड बनाया गया!", "success");
}

function generateLink() {
  const data = getFormValues();
  if(!data) return;
  
  let finalUrl = `${BASE_PAY_URL}?pa=${encodeURIComponent(data.pa)}`;
  if (data.am) { finalUrl += `&am=${encodeURIComponent(data.am)}`; }
  
  navigator.clipboard.writeText(finalUrl).then(() => { 
    showMessage(currentLang === 'en' ? "Payment Link Copied!" : "भुगतान लिंक कॉपी किया गया!", "success"); 
  }).catch(() => {
    showMessage(currentLang === 'en' ? "Failed to copy link" : "लिंक कॉपी करने में विफल", "error");
  });
}

function resetCreateForm() {
  document.getElementById("newUpiId").value = "";
  document.getElementById("newName").value = "";
  document.getElementById("newAmount").value = "";
  document.getElementById("newUpiId").classList.remove("valid", "invalid");
  document.getElementById("qrStandee").classList.add("hidden");
  document.getElementById("cardActions").classList.add("hidden");
  document.getElementById("createTab").scrollIntoView({ behavior: "smooth" });
}

// --- High-Resolution Export Engine ---
async function getCardBlob() {
  const cardElement = document.getElementById("qrStandee");
  const canvas = await html2canvas(cardElement, { scale: 3, backgroundColor: "#FFFFFF", logging: false });
  return new Promise(resolve => canvas.toBlob(resolve, "image/png"));
}

async function downloadStandee() {
  const btn = document.getElementById("btnDownload");
  btn.disabled = true; 
  try {
    const blob = await getCardBlob();
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'My-UPI-Card.png';
    link.click();
    URL.revokeObjectURL(url);
  } catch(err) {
    showMessage("Download failed.", "error");
  }
  btn.disabled = false;
}

async function shareStandee() {
  if (!navigator.share) return showMessage(currentLang === 'en' ? "Sharing not supported." : "साझाकरण समर्थित नहीं है।", "error");
  
  const btn = document.querySelector("#cardActions .btn-info");
  btn.disabled = true;
  try {
    const blob = await getCardBlob();
    const file = new File([blob], "My-UPI-Card.png", { type: "image/png" });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ title: 'Scan to Pay', files: [file] });
    } else {
      await navigator.share({ title: 'UPI ID', text: document.getElementById("newUpiId").value });
    }
  } catch (err) {}
  btn.disabled = false;
}
</script>

</body>
</html>
